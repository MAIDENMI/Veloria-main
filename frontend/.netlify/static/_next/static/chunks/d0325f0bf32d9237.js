(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,3919,e=>{"use strict";e.s(["default",()=>W],3919);var t=e.i(48277),n=e.i(30668),r=e.i(67054),o=e.i(37313),s=e.i(92206),a=e.i(35691),l=e.i(38777),i=e.i(30366),c=e.i(26884),u=e.i(85313),d=e.i(60954),g=e.i(17662),p=e.i(35719),h=e.i(7593),f=e.i(48077),m=e.i(35884);let x=(0,m.default)("phone",[["path",{d:"M13.832 16.568a1 1 0 0 0 1.213-.303l.355-.465A2 2 0 0 1 17 15h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2A18 18 0 0 1 2 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-.8 1.6l-.468.351a1 1 0 0 0-.292 1.233 14 14 0 0 0 6.392 6.384",key:"9njp5v"}]]);var b=e.i(16088);let v=(0,m.default)("arrow-up",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]),y=(0,m.default)("square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]),w=(0,m.default)("message-square",[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]]),j=(0,m.default)("file-text",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]]);var S=e.i(16506),N=e.i(41428);let k=n.createContext(void 0);function A(e){let{value:n,onValueChange:r,isLoading:o,onSubmit:s,className:a,children:l,...i}=e;return(0,t.jsx)(k.Provider,{value:{value:n,onValueChange:r,isLoading:o,onSubmit:s},children:(0,t.jsx)("div",{className:(0,N.cn)("relative",a),...i,children:l})})}function E(e){let{className:r,...o}=e,{value:s,onValueChange:a,onSubmit:l,isLoading:i}=function(){let e=n.useContext(k);if(!e)throw Error("usePromptInput must be used within a PromptInput");return e}(),c=n.useRef(null);return n.useEffect(()=>{c.current&&(c.current.style.height="auto",c.current.style.height="".concat(c.current.scrollHeight,"px"))},[s]),(0,t.jsx)("textarea",{ref:c,value:s,onChange:e=>a(e.target.value),onKeyDown:e=>{"Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),!i&&s.trim()&&l())},className:(0,N.cn)("w-full resize-none rounded-lg border bg-background px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),rows:1,...o})}function C(e){let{className:n,children:r,...o}=e;return(0,t.jsx)("div",{className:(0,N.cn)("flex items-center gap-2",n),...o,children:r})}function T(e){let{tooltip:n,className:r,children:o,...s}=e;return(0,t.jsx)("div",{className:(0,N.cn)("relative",r),title:n,...s,children:o})}var R=e.i(85205),_=function(e,t,n){if(n===t){for(var r=new Int16Array(e.length),o=0;o<e.length;o++){var s=Math.max(-1,Math.min(1,e[o]));r[o]=s<0?32768*s:32767*s}return r}for(var a=t/n,l=Math.round(e.length/a),i=new Int16Array(l),c=0,u=0;c<l;){for(var d=Math.round((c+1)*a),g=0,p=0,o=u;o<d&&o<e.length;o++)g+=e[o],p++;var s=Math.max(-1,Math.min(1,g/p));i[c]=s<0?32768*s:32767*s,c++,u=d}return i},M=function(e){for(var t="",n=new Uint8Array(e.buffer),r=0;r<n.byteLength;r++)t+=String.fromCharCode(n[r]);return btoa(t)},I=function(){function e(e,t,n){this.silenceStartTime=null,this.threshold=e,this.duration=t,this.onSilenceDetected=n}return e.prototype.processAudioData=function(e){for(var t=0,n=0;n<e.length;n++)t+=e[n]*e[n];if(20*Math.log10(Math.sqrt(t/e.length))<this.threshold){if(null===this.silenceStartTime)this.silenceStartTime=Date.now();else if(Date.now()-this.silenceStartTime>=this.duration&&this.onSilenceDetected)return this.onSilenceDetected(),!0}else this.silenceStartTime=null;return!1},e.prototype.reset=function(){this.silenceStartTime=null},e}(),L=function(e,t){var n,r,o,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=l(0),a.throw=l(1),a.return=l(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(l){return function(i){var c=[l,i];if(n)throw TypeError("Generator is already executing.");for(;a&&(a=0,c[0]&&(s=0)),s;)try{if(n=1,r&&(o=2&c[0]?r.return:c[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,c[1])).done)return o;switch(r=0,o&&(c=[2&c[0],o.value]),c[0]){case 0:case 1:o=c;break;case 4:return s.label++,{value:c[1],done:!1};case 5:s.label++,r=c[1],c=[0];continue;case 7:c=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===c[0]||2===c[0])){s=0;continue}if(3===c[0]&&(!o||c[1]>o[0]&&c[1]<o[3])){s.label=c[1];break}if(6===c[0]&&s.label<o[1]){s.label=o[1],o=c;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(c);break}o[2]&&s.ops.pop(),s.trys.pop();continue}c=t.call(e,s)}catch(e){c=[6,e],r=0}finally{n=o=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}},U=function(e){var t=e.onStartStreaming,r=e.onStopStreaming,o=e.onAudioChunked,s=e.onError,a=e.targetSampleRate,l=void 0===a?16e3:a,i=e.bufferSize,c=void 0===i?8192:i,u=e.enableSilenceDetection,d=void 0!==u&&u,g=e.silenceThreshold,p=void 0===g?-50:g,h=e.silenceDuration,f=void 0===h?1e3:h,m=e.autoStopOnSilence,x=void 0!==m&&m,b=e.includeDestination,v=void 0===b||b,y=(0,n.useState)(!1),w=y[0],j=y[1],S=(0,n.useRef)(null),N=(0,n.useRef)(null),k=(0,n.useRef)(null),A=(0,n.useRef)(null),E=(0,n.useRef)(null),C=(0,n.useCallback)(function(e){console.error("Voice stream error:",e),s&&s(e)},[s]),T=(0,n.useCallback)(function(){w&&(k.current&&(k.current.disconnect(),k.current.onaudioprocess=null,k.current=null),A.current&&(A.current.disconnect(),A.current=null),S.current&&(S.current.close(),S.current=null),N.current&&(N.current.getTracks().forEach(function(e){return e.stop()}),N.current=null),E.current&&(E.current.reset(),E.current=null),j(!1),r&&r())},[w,r]),R=(0,n.useCallback)(function(){var e,n,r,s;return e=void 0,n=void 0,r=void 0,s=function(){var e,n,r,s,a,i;return L(this,function(u){switch(u.label){case 0:if(w)return[2];u.label=1;case 1:return u.trys.push([1,3,,4]),[4,navigator.mediaDevices.getUserMedia({audio:!0})];case 2:return N.current=e=u.sent(),S.current=n=new window.AudioContext,r=n.sampleRate,A.current=s=n.createMediaStreamSource(e),k.current=a=n.createScriptProcessor(c,1,1),d&&(E.current=new I(p,f,x?T:void 0)),a.onaudioprocess=function(e){try{var t=e.inputBuffer.getChannelData(0);d&&E.current&&E.current.processAudioData(t);var n=_(t,r,l),s=M(n);o&&o(s)}catch(e){C(e instanceof Error?e:Error(String(e)))}},s.connect(a),v&&a.connect(n.destination),j(!0),t&&t(),[3,4];case 3:return C((i=u.sent())instanceof Error?i:Error(String(i))),[3,4];case 4:return[2]}})},new(r||(r=Promise))(function(t,o){function a(e){try{i(s.next(e))}catch(e){o(e)}}function l(e){try{i(s.throw(e))}catch(e){o(e)}}function i(e){var n;e.done?t(e.value):((n=e.value)instanceof r?n:new r(function(e){e(n)})).then(a,l)}i((s=s.apply(e,n||[])).next())})},[w,t,o,s,l,c,d,p,f,x,v,T,C]);return(0,n.useEffect)(function(){return function(){T()}},[T]),{startStreaming:R,stopStreaming:T,isStreaming:w}};let P=(e,t)=>{e.readyState===WebSocket.OPEN&&e.send(JSON.stringify(t))},D=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{agentId:t,signedUrl:r,useAgentAudio:o=!1,isMuted:s=!1,onUserTranscript:a,onAgentResponse:l,onAgentResponseCorrection:i,onInterruption:c,onConnectionStatusChange:u,onAudioReceived:d}=e,g=(0,n.useRef)(null),[p,h]=(0,n.useState)(!1),[f,m]=(0,n.useState)(null),{enqueueAudio:x,clearQueue:b,stopCurrentAudio:v,isPlaying:y}=(()=>{let[e,t]=(0,n.useState)(!1),r=(0,n.useRef)([]),o=(0,n.useRef)(null),s=(0,n.useRef)(null),a=(0,n.useCallback)(()=>(o.current||(o.current=new(window.AudioContext||window.webkitAudioContext)),o.current),[]),l=(0,n.useCallback)(async function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Promise((n,r)=>{try{let o=a();if(console.log("🔊 Processing audio buffer, size:",e.byteLength,"isPCM:",t),t){let t=new Int16Array(e),r=new Float32Array(t.length);for(let e=0;e<t.length;e++)r[e]=t[e]/32768;let a=o.createBuffer(1,r.length,16e3);a.getChannelData(0).set(r),console.log("✅ PCM audio buffer created:",{duration:a.duration,channels:a.numberOfChannels,sampleRate:a.sampleRate,samples:r.length});let l=o.createBufferSource();l.buffer=a,l.connect(o.destination),s.current=l,l.onended=()=>{console.log("✅ Audio playback finished"),s.current=null,n()},console.log("🔊 Starting PCM audio playback..."),l.start(0)}else o.decodeAudioData(e,e=>{console.log("✅ Audio decoded successfully:",{duration:e.duration,channels:e.numberOfChannels,sampleRate:e.sampleRate});let t=o.createBufferSource();t.buffer=e,t.connect(o.destination),s.current=t,t.onended=()=>{console.log("✅ Audio playback finished"),s.current=null,n()},console.log("🔊 Starting Web Audio playback..."),t.start(0)},e=>{console.error("❌ Audio decode error:",e),r(Error("Failed to decode audio: ".concat(e.message||e)))})}catch(e){console.error("❌ Error in playAudioBuffer:",e),r(e)}})},[a]),i=(0,n.useCallback)(async()=>{if(!e&&0!==r.current.length){for(console.log("🎵 Processing Web Audio queue, items:",r.current.length),t(!0);r.current.length>0;){let e=r.current.shift();if(e)try{await l(e,!0)}catch(e){console.error("❌ Error playing audio chunk:",e instanceof Error?e.message:e)}}console.log("✅ Web Audio queue processing complete"),t(!1)}},[e,l]),c=(0,n.useCallback)(e=>{console.log("➕ Enqueueing Web Audio chunk, queue size:",r.current.length+1);try{let t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);r.current.push(n.buffer),i()}catch(e){console.error("❌ Error enqueueing audio:",e)}},[i]);return{enqueueAudio:c,clearQueue:(0,n.useCallback)(()=>{if(console.log("🗑️ Clearing Web Audio queue"),r.current=[],s.current){try{s.current.stop()}catch(e){}s.current=null}t(!1)},[]),stopCurrentAudio:(0,n.useCallback)(()=>{if(s.current){try{s.current.stop()}catch(e){}s.current=null}},[]),isPlaying:e,queueLength:r.current.length}})(),w=(0,n.useRef)(o);w.current=o;let{startStreaming:j,stopStreaming:S}=U({onAudioChunked:e=>g.current?s?void console.log("🔇 Microphone muted - not sending audio chunk"):void(console.log("🎤 Sending audio chunk to agent, size:",e.length,"bytes"),P(g.current,{user_audio_chunk:e})):void console.warn("⚠️ WebSocket not connected, cannot send audio chunk")}),N=(0,n.useCallback)(async()=>{if(p)return void console.warn("⚠️ Already connected to agent");m(null),console.log("🔧 Starting ElevenLabs conversation...",{agentId:t,signedUrl:r});try{let e;if(r)e=r,console.log("🔐 Using signed URL for private agent");else if(t)e="wss://api.elevenlabs.io/v1/convai/conversation?agent_id=".concat(t),console.log("🌐 Using public agent ID:",t);else throw Error("Either agentId or signedUrl must be provided");console.log("🔌 Connecting to WebSocket:",e.substring(0,60)+"...");let n=new WebSocket(e);n.onopen=()=>{console.log("✅ WebSocket connected to ElevenLabs agent"),h(!0),null==u||u(!0),console.log("🎤 Starting audio streaming..."),j()},n.onerror=e=>{console.error("❌ WebSocket error:",e),m("Failed to connect to ElevenLabs agent. Check your Agent ID and network connection.")},n.onmessage=e=>{try{let r=JSON.parse(e.data);if("ping"===r.type&&setTimeout(()=>{P(n,{type:"pong",event_id:r.ping_event.event_id})},r.ping_event.ping_ms||0),"user_transcript"===r.type){let{user_transcription_event:e}=r;console.log("User transcript:",e.user_transcript),null==a||a(e.user_transcript)}if("agent_response"===r.type){let{agent_response_event:e}=r;console.log("Agent response:",e.agent_response),null==l||l(e.agent_response)}if("agent_response_correction"===r.type){let{agent_response_correction_event:e}=r;console.log("Agent response correction:",e.corrected_agent_response),null==i||i(e.original_agent_response,e.corrected_agent_response)}if("interruption"===r.type){let{interruption_event:e}=r;console.log("Interruption:",e.reason),null==c||c(e.reason),b()}if("audio"===r.type){var t;let{audio_event:e}=r,n=w.current;console.log("🎵 Received audio chunk:",{eventId:e.event_id,audioLength:(null==(t=e.audio_base_64)?void 0:t.length)||0,hasAudioData:!!e.audio_base_64,useAgentAudio:n}),e.audio_base_64?(n?(console.log("🔊 Using ElevenLabs agent audio - playing through Web Audio"),x(e.audio_base_64)):console.log("🔇 Ignoring ElevenLabs audio (using external TTS)"),null==d||d(e.audio_base_64)):console.warn("⚠️ Received audio event with no data")}}catch(e){console.error("Error parsing WebSocket message:",e)}},n.onclose=async e=>{console.log("🔌 WebSocket connection closed",{code:e.code,reason:e.reason,wasClean:e.wasClean}),g.current=null,h(!1),null==u||u(!1),S(),b()},g.current=n}catch(e){console.error("Error starting conversation:",e),m(e instanceof Error?e.message:"Unknown error"),h(!1),null==u||u(!1)}},[p,t,r,j,S,a,l,i,c,u,d,x,b]),k=(0,n.useCallback)(async()=>{if(g.current){console.log("🛑 Ending ElevenLabs conversation session..."),v(),b();try{P(g.current,{type:"end_of_conversation"}),console.log("✅ Sent end_of_conversation message"),await new Promise(e=>setTimeout(e,200))}catch(e){console.error("Error sending end_of_conversation:",e)}g.current.close(),console.log("🔌 WebSocket closed")}},[b,v]),A=(0,n.useCallback)(e=>{if(!g.current||!p)return void console.warn("Cannot send contextual update: not connected");P(g.current,{type:"contextual_update",text:e})},[p]),E=(0,n.useCallback)(()=>{v(),b()},[v,b]);return(0,n.useEffect)(()=>()=>{g.current&&g.current.close()},[]),{startConversation:N,stopConversation:k,sendContextualUpdate:A,interruptAgent:E,isConnected:p,isAgentSpeaking:y,error:f}};e.i(39057);let O={elevenlabs:{agentId:"agent_3401k6t9cnjnecn82gj1j93pwjkn",apiKey:"sk_1edef29303516b19456f067f2c1e4f50e2c15773cff0a4e4"},google:{apiKey:""},talkingHead:{url:"http://localhost:8080"}};function W(){let[e,m]=(0,n.useState)(!1),[N,k]=(0,n.useState)(0),[_,M]=(0,n.useState)("pip"),[I,L]=(0,n.useState)(null),[U,P]=(0,n.useState)(!0),[W,q]=(0,n.useState)(!0),[K,B]=(0,n.useState)(!1),[z,V]=(0,n.useState)(0),[H,F]=(0,n.useState)(!1),[G,J]=(0,n.useState)(!1),[Y,X]=(0,n.useState)("eleven"),[Q,Z]=(0,n.useState)(!0),[$,ee]=(0,n.useState)(!1),[et,en]=(0,n.useState)(""),[er,eo]=(0,n.useState)(""),[es,ea]=(0,n.useState)(!1),[el,ei]=(0,n.useState)(!1),[ec,eu]=(0,n.useState)([]),[ed,eg]=(0,n.useState)(null),[ep,eh]=(0,n.useState)(!1),[ef,em]=(0,n.useState)(""),[ex,eb]=(0,n.useState)(!1),[ev,ey]=(0,n.useState)(!1),ew=(0,n.useRef)(null),ej=(0,n.useRef)(null),eS=(0,n.useRef)(null),eN=(0,n.useRef)(null),ek=(0,n.useRef)("user_".concat(Date.now())),eA=(0,n.useRef)(null),eE=(0,n.useRef)(null),eC=(0,n.useRef)(null),eT=(0,n.useRef)(null),eR=(0,n.useRef)(null),e_=async()=>{try{console.log("🎤 Starting audio level monitoring...");let e=await navigator.mediaDevices.getUserMedia({audio:!0});eT.current=e;let t=new AudioContext;eA.current=t;let n=t.createAnalyser();n.fftSize=256,n.smoothingTimeConstant=.8,eE.current=n,t.createMediaStreamSource(e).connect(n);let r=new Uint8Array(n.frequencyBinCount),o=()=>{if(!eE.current)return;eE.current.getByteFrequencyData(r);let e=r.reduce((e,t)=>e+t,0)/r.length,t=Math.min(e/100,1.5);k(t),eC.current=requestAnimationFrame(o)};o(),console.log("✅ Audio level monitoring started")}catch(e){console.error("❌ Error starting audio level monitoring:",e)}},eM=()=>{console.log("🔇 Stopping audio level monitoring..."),eC.current&&(cancelAnimationFrame(eC.current),eC.current=null),eT.current&&(eT.current.getTracks().forEach(e=>e.stop()),eT.current=null),eA.current&&(eA.current.close(),eA.current=null),eE.current=null,k(0)},{startConversation:eI,stopConversation:eL,isConnected:eU,isAgentSpeaking:eP,error:eD,sendContextualUpdate:eO,interruptAgent:eW}=D({agentId:O.elevenlabs.agentId,useAgentAudio:!1,isMuted:!U,onUserTranscript:e=>{console.log("👤 User said:",e),en(e),eu(t=>[...t,{role:"user",content:e}])},onAgentResponse:e=>{console.log("🤖 Agent text response received:",e),eo(e),eu(t=>[...t,{role:"assistant",content:e}]),eN.current&&eN.current.contentWindow&&(console.log("📤 Sending text to TalkingHead for TTS + animation"),ee(!0),eN.current.contentWindow.postMessage({type:"speak",payload:{text:e}},"http://localhost:8080"),setTimeout(()=>{ee(!1)},e.split(" ").length/150*6e4))},onAgentResponseCorrection:(e,t)=>{console.log("✏️ Agent corrected response:",t),eo(t),eu(e=>{let n=[...e];return n.length>0&&"assistant"===n[n.length-1].role&&(n[n.length-1].content=t),n})},onInterruption:e=>{console.log("⚠️ Conversation interrupted:",e),ei(!1)},onConnectionStatusChange:e=>{console.log("🔌 Agent connection status:",e),m(e)}}),eq=(0,l.useMotionValue)(0),eK=(0,l.useMotionValue)(0),eB=async()=>{try{(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop())}catch(e){console.error("Microphone permission denied:",e),eg("Microphone access is required for voice chat. Please allow microphone access and try again."),eh(!0);return}if(!("webkitSpeechRecognition"in window)&&!("SpeechRecognition"in window))return void alert("Speech recognition not supported in this browser. Please use Chrome, Edge, or Safari.");let e=new(window.SpeechRecognition||window.webkitSpeechRecognition);e.continuous=!1,e.interimResults=!1,e.lang="en-US",e.onstart=()=>{ea(!0),m(!0),en(""),eo("")},e.onresult=e=>{let t=e.results[0][0].transcript;en(t),ea(!1),m(!1),ez(t)},e.onerror=e=>{console.error("Speech recognition error:",e.error),ea(!1),m(!1),eo("Sorry, I couldn't hear you clearly. Please try again.")},e.onend=()=>{ea(!1),m(!1)},eS.current=e,e.start()},ez=async e=>{ei(!0);try{let t=await fetch("http://localhost:8000/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e,context:ec.slice(-4),user_id:ek.current})});if(!t.ok)throw Error("AI Service Error: ".concat(t.status));let n=await t.json();eo(n.response),eu(t=>[...t,{role:"user",content:e},{role:"assistant",content:n.response}]),eN.current&&eV(n.response)}catch(t){console.error("Error:",t);let e="I'm having trouble connecting. Please check that the backend services are running.";eo(e),eN.current&&eV(e)}finally{ei(!1)}},eV=async e=>{try{ee(!0),eN.current&&eN.current.contentWindow&&eN.current.contentWindow.postMessage({type:"SPEAK",text:e,voice:"Rachel"},"http://localhost:8080");let t=await fetch("http://localhost:8001/voice/synthesize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,voice_id:"21m00Tcm4TlvDq8ikWAM"})});if(t.ok){let e=await t.json();e.audio_base64&&await eH(e.audio_base64)}}catch(e){console.error("TalkingHead speak error:",e),ee(!1)}},eH=e=>new Promise((t,n)=>{try{let r=atob(e),o=new Uint8Array(r.length);for(let e=0;e<r.length;e++)o[e]=r.charCodeAt(e);let s=new Blob([o],{type:"audio/mpeg"}),a=URL.createObjectURL(s),l=new Audio(a);l.onended=()=>{URL.revokeObjectURL(a),ee(!1),t()},l.onerror=e=>{URL.revokeObjectURL(a),ee(!1),n(e)},l.play().catch(n)}catch(e){ee(!1),n(e)}});(0,n.useEffect)(()=>{let e=setInterval(()=>{V(e=>e+1)},1e3);return()=>clearInterval(e)},[]);let eF=e=>{let t=Math.floor(e/60);return"".concat(t.toString().padStart(2,"0"),":").concat((e%60).toString().padStart(2,"0"))};(0,n.useEffect)(()=>{try{let e=sessionStorage.getItem("voice-provider")||"eleven";X(e);let t=sessionStorage.getItem("use-websocket");Z(null===t||"true"===t)}catch(e){}},[]);let eG=(e,t)=>{try{var n;let r=null==(n=eN.current)?void 0:n.contentWindow;if(!r)return;r.postMessage({type:e,payload:t},O.talkingHead.url)}catch(e){}},eJ=()=>{console.log("🎬 TalkingHead iframe loaded"),console.log("🔧 Applying settings to TalkingHead iframe",{hasGoogleKey:!!O.google.apiKey,hasElevenLabsKey:!!O.elevenlabs.apiKey,voiceProvider:Y}),O.google.apiKey?(console.log("📤 Sending Google API key to iframe"),eG("saveApiKey",{provider:"google",key:O.google.apiKey})):console.warn("⚠️ No Google API key found in config"),O.elevenlabs.apiKey?(console.log("📤 Sending ElevenLabs API key to iframe"),eG("saveApiKey",{provider:"eleven",key:O.elevenlabs.apiKey})):console.warn("⚠️ No ElevenLabs API key found in config. Add NEXT_PUBLIC_ELEVENLABS_API_KEY to .env.local"),eG("setVoice",{value:Y}),setTimeout(()=>{console.log("✅ Setting avatar as ready"),eb(!0)},1500)},eY=(0,n.useCallback)(async()=>{if(console.log("🎙️ Toggle conversation clicked",{useWebSocket:Q,isAgentConnected:eU,agentId:O.elevenlabs.agentId}),!Q)return void eB();if(eU)console.log("🛑 Ending conversation immediately..."),ee(!1),eW(),eN.current&&eN.current.contentWindow&&(console.log("🔇 Stopping TalkingHead speech"),eN.current.contentWindow.postMessage({type:"stop"},"http://localhost:8080")),ec.length>0&&eX(),await eL(),eM(),en(""),eo(""),ey(!0),console.log("✅ Conversation ended");else{if(!O.elevenlabs.agentId){console.warn("❌ No Agent ID configured"),alert("Please configure your ElevenLabs Agent ID in the .env.local file.\n\nAdd: NEXT_PUBLIC_ELEVENLABS_AGENT_ID=your_agent_id");return}console.log("🚀 Starting conversation with Agent ID:",O.elevenlabs.agentId),console.log("🎯 Flow: Agent provides text → TalkingHead handles TTS + animation"),console.log("🔊 Voice Provider:","eleven"===Y?"ElevenLabs TTS":"Google TTS"),ey(!1);try{console.log("🎤 Requesting microphone permission...");let e=await navigator.mediaDevices.getUserMedia({audio:!0});console.log("✅ Microphone permission granted"),e.getTracks().forEach(e=>e.stop()),await e_(),console.log("🔌 Initiating WebSocket connection..."),await eI(),console.log("✅ Conversation started successfully")}catch(e){console.error("❌ Error starting conversation:",e),eg("Microphone access is required for voice chat. Please allow microphone access and try again."),eh(!0)}}},[Q,eU,eO,eL,eI,Y,eW]),eX=()=>{try{let e={id:"session_".concat(Date.now()),title:"Therapy Session - ".concat(new Date().toLocaleDateString()),date:new Date().toISOString(),duration:eF(z),messages:ec,summary:ec.length>0?ec[0].content.substring(0,100)+"...":"No conversation"},t=JSON.parse(localStorage.getItem("therapy_sessions")||"[]");t.unshift(e),localStorage.setItem("therapy_sessions",JSON.stringify(t)),console.log("✅ Session saved to history")}catch(e){console.error("❌ Error saving session:",e)}};return(0,n.useEffect)(()=>{let e=e=>{let t=e.target;t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName||t.isContentEditable)||("Space"===e.code&&(e.preventDefault(),eY()),"m"===e.key.toLowerCase()&&P(e=>!e),"v"===e.key.toLowerCase()&&q(e=>!e),"c"===e.key.toLowerCase()&&B(e=>!e))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[eY]),(0,n.useEffect)(()=>((async function(){try{let e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});L(e)}catch(e){console.error("Error accessing webcam:",e),"NotAllowedError"===e.name?console.log("Camera/microphone permission denied. User can still use voice chat without video."):"NotFoundError"===e.name?console.log("No camera/microphone found. User can still use voice chat."):console.log("Camera setup failed:",e.message||"Unknown error")}})(),()=>{I&&I.getTracks().forEach(e=>e.stop())}),[]),(0,n.useEffect)(()=>{ew.current&&I&&(ew.current.srcObject=I)},[I,_]),(0,n.useEffect)(()=>{if(I){let e=I.getVideoTracks()[0];e&&(e.enabled=W)}},[W,I]),(0,n.useEffect)(()=>{if(I){let e=I.getAudioTracks()[0];e&&(e.enabled=U)}},[U,I]),(0,n.useEffect)(()=>{eU||eM()},[eU]),(0,n.useEffect)(()=>()=>{eM()},[]),(0,n.useEffect)(()=>{var e;null==(e=eR.current)||e.scrollIntoView({behavior:"smooth"})},[ec,el,eP]),(0,n.useEffect)(()=>{let e=setTimeout(()=>{ex||(console.log("⏰ Fallback: Setting avatar as ready after timeout"),eb(!0))},3e3);return()=>clearTimeout(e)},[ex]),(0,t.jsxs)("div",{className:"relative w-full h-screen overflow-hidden",children:[(0,t.jsx)(r.default,{audioLevel:N,isListening:e}),(0,t.jsx)("div",{className:"relative z-10 flex items-center justify-center h-full p-8",children:(0,t.jsxs)("div",{className:"w-full h-full flex flex-col px-6 py-2 gap-1",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between my-4",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("h2",{className:"text-lg font-medium text-foreground",children:"AI Therapy Session"}),Q&&(0,t.jsxs)("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-full border ".concat(eU?"bg-green-500/20 border-green-500/50":"bg-gray-500/20 border-gray-500/50"),children:[(0,t.jsx)("div",{className:"w-2 h-2 rounded-full ".concat(eU?"bg-green-500 animate-pulse":"bg-gray-500")}),(0,t.jsx)("span",{className:"text-xs font-medium",children:eU?"Live":"Offline"})]})]}),(0,t.jsxs)(a.motion.div,{className:"flex px-4 py-2 border items-center justify-center rounded-full gap-2",initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{duration:.3},children:[(0,t.jsx)(a.motion.div,{className:"w-2 h-2 bg-red-600 rounded-full",animate:{opacity:[1,.3,1]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),(0,t.jsx)("div",{className:"text-sm text-muted-foreground font-mono",children:eF(z)})]})]}),(0,t.jsxs)("div",{className:"flex-1 flex items-start justify-center overflow-hidden",children:[(0,t.jsxs)("div",{className:"flex-1 flex items-center justify-center h-full",children:["pip"===_&&(0,t.jsxs)("div",{ref:ej,className:"relative w-full h-full bg-gray-900 rounded-xl overflow-hidden",children:[(0,t.jsx)("iframe",{ref:eN,onLoad:eJ,src:"http://localhost:8080/index-modular.html",className:"w-full h-full border-0 transition-opacity duration-700 ".concat(ex?"opacity-100":"opacity-0"),allow:"camera; microphone; autoplay; fullscreen"}),!ex&&(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-900",children:(0,t.jsxs)("div",{className:"flex flex-col items-center gap-4",children:[(0,t.jsxs)("div",{className:"relative w-16 h-16",children:[(0,t.jsx)("div",{className:"absolute inset-0 rounded-full border-4 border-purple-500/20"}),(0,t.jsx)("div",{className:"absolute inset-0 rounded-full border-4 border-transparent border-t-purple-500 animate-spin"})]}),(0,t.jsxs)("div",{className:"text-center space-y-1",children:[(0,t.jsx)("p",{className:"text-sm font-medium text-white",children:"Loading Avatar"}),(0,t.jsx)("p",{className:"text-xs text-gray-400",children:"Preparing your session..."})]})]})}),K&&(0,t.jsxs)("div",{className:"absolute bottom-6 left-6 max-w-2xl space-y-2",children:[(0,t.jsxs)("div",{className:"flex gap-2",children:[Q&&eU&&(0,t.jsxs)("div",{className:"bg-green-500/20 backdrop-blur-sm px-3 py-1.5 rounded-full border border-green-400/50 inline-flex items-center gap-2",children:[(0,t.jsx)("div",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"}),(0,t.jsx)("p",{className:"text-green-200 text-xs",children:"Live Connection Active"})]}),!U&&(0,t.jsxs)("div",{className:"bg-red-500/20 backdrop-blur-sm px-3 py-1.5 rounded-full border border-red-400/50 inline-flex items-center gap-2",children:[(0,t.jsx)(g.MicOff,{className:"w-3 h-3 text-red-400"}),(0,t.jsx)("p",{className:"text-red-200 text-xs",children:"Muted"})]})]}),et&&(0,t.jsxs)("div",{className:"bg-blue-500/20 backdrop-blur-sm p-3 rounded-lg border border-blue-400/50",children:[(0,t.jsx)("p",{className:"text-blue-200 text-xs mb-1",children:"You:"}),(0,t.jsx)("p",{className:"text-white text-sm",children:et})]}),er&&(0,t.jsxs)("div",{className:"bg-purple-500/20 backdrop-blur-sm p-3 rounded-lg border border-purple-400/50",children:[(0,t.jsx)("p",{className:"text-purple-200 text-xs mb-1",children:"EMURA:"}),(0,t.jsx)(s.FadingTextStream,{text:er,speed:50,className:"text-white text-sm",lines:3,showGradients:!1})]}),(el||eP)&&(0,t.jsx)("div",{className:"bg-gray-500/20 backdrop-blur-sm p-3 rounded-lg border border-gray-400/50",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)("div",{className:"flex gap-1",children:[(0,t.jsx)("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce"}),(0,t.jsx)("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce delay-100"}),(0,t.jsx)("div",{className:"w-2 h-2 bg-white rounded-full animate-bounce delay-200"})]}),(0,t.jsx)("span",{className:"text-white text-sm",children:eP?"EMURA is speaking...":"EMURA is thinking..."})]})})]}),(0,t.jsx)(a.motion.div,{drag:!0,dragMomentum:!1,dragElastic:.05,dragConstraints:ej,style:{x:eq,y:eK},onDragEnd:()=>{if(!ej.current)return;let e=ej.current.getBoundingClientRect(),t=eq.get(),n=eK.get(),r=-(e.width-192-32),o=-(e.height-144-32),s=0,a=0;s=t<r/2?r:0,a=n<o/2?o:0,(0,i.animate)(eq,s,{type:"spring",stiffness:300,damping:30}),(0,i.animate)(eK,a,{type:"spring",stiffness:300,damping:30})},className:"absolute bottom-4 right-4 w-48 h-36 bg-gray-800 rounded-lg shadow-lg border-2 border-gray-700 overflow-hidden cursor-move",children:(0,t.jsx)("video",{ref:ew,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover scale-x-[-1]"})})]}),"split"===_&&(0,t.jsxs)("div",{className:"w-full h-full flex gap-4",children:[(0,t.jsxs)("div",{className:"relative w-1/2 h-full bg-gray-900 rounded-xl overflow-hidden flex items-center justify-center",children:[(0,t.jsx)("iframe",{ref:eN,onLoad:eJ,src:"http://localhost:8080/index-modular.html",className:"w-full h-full border-0 transition-opacity duration-700 ".concat(ex?"opacity-100":"opacity-0"),allow:"camera; microphone; autoplay; fullscreen"}),!ex&&(0,t.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-900",children:(0,t.jsxs)("div",{className:"flex flex-col items-center gap-4",children:[(0,t.jsxs)("div",{className:"relative w-16 h-16",children:[(0,t.jsx)("div",{className:"absolute inset-0 rounded-full border-4 border-purple-500/20"}),(0,t.jsx)("div",{className:"absolute inset-0 rounded-full border-4 border-transparent border-t-purple-500 animate-spin"})]}),(0,t.jsxs)("div",{className:"text-center space-y-1",children:[(0,t.jsx)("p",{className:"text-sm font-medium text-white",children:"Loading Avatar"}),(0,t.jsx)("p",{className:"text-xs text-gray-400",children:"Preparing your session..."})]})]})}),K&&(0,t.jsxs)("div",{className:"absolute bottom-6 left-6 max-w-xl space-y-2",children:[et&&(0,t.jsxs)("div",{className:"bg-blue-500/20 backdrop-blur-sm p-3 rounded-lg border border-blue-400/50",children:[(0,t.jsx)("p",{className:"text-blue-200 text-xs mb-1",children:"You:"}),(0,t.jsx)("p",{className:"text-white text-sm",children:et})]}),er&&(0,t.jsxs)("div",{className:"bg-purple-500/20 backdrop-blur-sm p-3 rounded-lg border border-purple-400/50",children:[(0,t.jsx)("p",{className:"text-purple-200 text-xs mb-1",children:"EMURA:"}),(0,t.jsx)(s.FadingTextStream,{text:er,speed:50,className:"text-white text-sm",lines:3,showGradients:!1})]})]})]}),(0,t.jsx)("div",{className:"w-1/2 h-full bg-gray-800 rounded-xl overflow-hidden border-2 border-gray-700",children:(0,t.jsx)("video",{ref:ew,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover scale-x-[-1]"})})]})]}),(0,t.jsx)(a.motion.div,{initial:!1,animate:{width:G?"450px":0,opacity:+!!G},transition:{duration:.3,ease:"easeInOut"},className:"overflow-hidden h-full",children:(0,t.jsxs)("div",{className:"w-[450px] h-full bg-muted/30 backdrop-blur-sm border rounded-lg flex flex-col overflow-hidden",children:[(0,t.jsxs)("div",{className:"p-4 border-b",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,t.jsx)("h3",{className:"text-sm font-semibold",children:"Conversation"}),(0,t.jsxs)("div",{className:"flex items-center gap-2 px-2 py-1 rounded-full text-xs ".concat(eU?"bg-green-500/20 text-green-400":"bg-gray-500/20 text-gray-400"),children:[(0,t.jsx)("div",{className:"w-1.5 h-1.5 rounded-full ".concat(eU?"bg-green-400 animate-pulse":"bg-gray-400")}),eU?"Connected":"Offline"]})]}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:0===ec.length?"Start a conversation with EMURA":"".concat(ec.length," messages")})]}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto px-5 py-4",style:{scrollbarWidth:"thin",scrollbarColor:"rgba(0,0,0,0.15) transparent"},children:0===ec.length?(0,t.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,t.jsxs)("div",{className:"text-center space-y-2",children:[(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"No messages yet"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"Start a session to begin"})]})}):(0,t.jsxs)("div",{className:"space-y-4 max-w-3xl",children:[(0,t.jsxs)("div",{className:"text-[9px] uppercase tracking-wider text-muted-foreground pb-2 border-b",children:[new Date().toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"}).toUpperCase()," • ",new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})]}),(0,t.jsxs)("div",{className:"space-y-4",children:[ec.map((e,n)=>(0,t.jsxs)(a.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},className:"user"===e.role?"space-y-1.5":"border-l-2 border-purple-500/30 pl-4 space-y-1.5",children:[(0,t.jsx)("div",{className:"text-[10px] font-medium uppercase tracking-wider ".concat("user"===e.role?"text-blue-500":"text-purple-500"),children:"user"===e.role?"You":"EMURA"}),(0,t.jsx)("div",{className:"text-sm leading-relaxed text-foreground whitespace-pre-wrap break-words",children:e.content})]},n)),(el||eP)&&(0,t.jsxs)(a.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"border-l-2 border-purple-500/30 pl-4 space-y-1.5",children:[(0,t.jsx)("div",{className:"text-[10px] font-medium uppercase tracking-wider text-purple-500",children:"EMURA"}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)("div",{className:"flex gap-1",children:[(0,t.jsx)("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-bounce"}),(0,t.jsx)("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-bounce delay-100"}),(0,t.jsx)("div",{className:"w-2 h-2 bg-purple-400 rounded-full animate-bounce delay-200"})]}),(0,t.jsx)("span",{className:"text-xs text-purple-500/70",children:eP?"speaking...":"thinking..."})]})]})]}),(0,t.jsx)("div",{ref:eR})]})}),(0,t.jsx)("div",{className:"p-4 border-t",children:ev&&ec.length>0?(0,t.jsx)(S.default,{href:"/history",children:(0,t.jsxs)(a.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex items-center justify-center gap-3 p-4 bg-gradient-to-r from-purple-500/20 to-blue-500/20 hover:from-purple-500/30 hover:to-blue-500/30 rounded-lg border border-purple-500/30 hover:border-purple-500/50 transition-all cursor-pointer group",children:[(0,t.jsx)(j,{className:"w-5 h-5 text-purple-400 group-hover:text-purple-300 transition-colors"}),(0,t.jsxs)("div",{className:"flex flex-col items-start",children:[(0,t.jsx)("span",{className:"text-sm font-semibold text-purple-300 group-hover:text-purple-200 transition-colors",children:"AI Analysis"}),(0,t.jsx)("span",{className:"text-xs text-purple-400/70",children:"Session saved • Click to review"})]})]})}):(0,t.jsxs)(A,{value:ef,onValueChange:em,isLoading:el||eP,onSubmit:()=>{let e=ef.trim();e&&(eu(t=>[...t,{role:"user",content:e}]),Q&&eU?eO(e):ez(e),em(""))},children:[(0,t.jsx)(E,{placeholder:"Type a message to EMURA...",className:"min-h-[60px] resize-none",disabled:!eU&&Q}),(0,t.jsxs)(C,{children:[(0,t.jsx)(T,{tooltip:"Send Message",children:(0,t.jsx)(R.Button,{size:"sm",type:"submit",disabled:!eU&&Q||!ef.trim(),children:(0,t.jsx)(v,{className:"w-4 h-4"})})}),eU&&eP&&(0,t.jsx)(T,{tooltip:"Stop Speaking",children:(0,t.jsx)(R.Button,{size:"sm",variant:"destructive",onClick:()=>{eW(),ee(!1)},children:(0,t.jsx)(y,{className:"w-4 h-4"})})})]})]})})]})})]}),(0,t.jsx)("div",{className:"flex items-center justify-center gap-8 w-full mt-6",children:(0,t.jsx)("div",{className:"flex-shrink-0",children:(0,t.jsx)(o.Dock,{className:"w-auto h-auto",items:[eU?{icon:U?d.Mic:g.MicOff,label:U?"Mute":"Unmute",onClick:()=>P(e=>!e),isActive:!U}:{icon:x,label:"Start session",onClick:eY,isActive:!1},...eU?[{icon:f.PhoneOff,label:"End call",onClick:eY,isActive:!0}]:[],{icon:W?p.Video:h.VideoOff,label:W?"Turn off camera":"Turn on camera",onClick:()=>q(!W),isActive:W},{icon:b.Subtitles,label:K?"Turn off captions":"Turn on captions",onClick:()=>B(!K),isActive:K},{icon:"pip"===_?c.Grid2x2:u.Maximize2,label:"pip"===_?"Split view":"Picture-in-picture",onClick:()=>M("pip"===_?"split":"pip")},{icon:w,label:G?"Close chat history":"Show chat history",onClick:()=>J(!G),isActive:G}]})})})]})}),ep&&(0,t.jsx)("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4",children:(0,t.jsxs)(a.motion.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"bg-white rounded-lg p-6 max-w-md w-full shadow-xl",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Microphone Permission Required"}),(0,t.jsx)("p",{className:"text-gray-600 mb-4",children:ed}),(0,t.jsxs)("div",{className:"text-sm text-gray-500 mb-6",children:[(0,t.jsx)("p",{className:"mb-2",children:(0,t.jsx)("strong",{children:"To enable voice chat:"})}),(0,t.jsxs)("ol",{className:"list-decimal list-inside space-y-1",children:[(0,t.jsx)("li",{children:"Click the microphone icon in your browser's address bar"}),(0,t.jsx)("li",{children:'Select "Allow" for microphone access'}),(0,t.jsx)("li",{children:"Refresh the page and try again"})]})]}),(0,t.jsxs)("div",{className:"flex gap-3",children:[(0,t.jsx)("button",{onClick:()=>{eh(!1),eg(null)},className:"flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors",children:"Close"}),(0,t.jsx)("button",{onClick:()=>window.location.reload(),className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Refresh Page"})]})]})})]})}}]);